name: Build and Deploy with Helm

on:
  push:
    branches:
      - main
      - developer
      - staging
  workflow_dispatch:  # Allow manual triggering from GitHub UI

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  HELM_CHART_PATH: helm/restaurant-system

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.set_sha.outputs.short_sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set SHORT_SHA
        id: set_sha
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:latest,${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:${{ env.SHORT_SHA }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:latest
          cache-to: type=inline

      - name: Build and Push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/api-gateway/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:latest,${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:${{ env.SHORT_SHA }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:latest
          cache-to: type=inline

      - name: Build and Push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/auth-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest,${{ secrets.DOCKERHUB_USERNAME }}/auth-service:${{ env.SHORT_SHA }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest
          cache-to: type=inline

      - name: Build and Push Restaurant Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/restaurant-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:latest,${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:${{ env.SHORT_SHA }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:latest
          cache-to: type=inline

      - name: Build and Push Order Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/order-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/order-service:latest,${{ secrets.DOCKERHUB_USERNAME }}/order-service:${{ env.SHORT_SHA }}
          cache-from: type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/order-service:latest
          cache-to: type=inline

      - name: Build Summary
        run: |
          echo "========================================="
          echo "‚úÖ Docker Images Built and Pushed"
          echo "========================================="
          echo "Images pushed to DockerHub:"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:${{ env.SHORT_SHA }}"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:${{ env.SHORT_SHA }}"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:${{ env.SHORT_SHA }}"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:${{ env.SHORT_SHA }}"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/order-service:${{ env.SHORT_SHA }}"
          echo ""
          echo "üìù Images tagged with:"
          echo "  - latest"
          echo "  - ${{ env.SHORT_SHA }}"

  update-helm-values:
    name: Update Helm Values and Commit
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Wait for DockerHub images
        run: |
          echo "Waiting for images to be available on DockerHub..."
          sleep 30
          echo "‚úÖ Images should now be available"

      - name: Verify images on DockerHub
        run: |
          echo "Verifying images are available on DockerHub..."
          SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"

          # Function to check if image exists
          check_image() {
            IMAGE=$1
            echo "Checking $IMAGE..."
            if docker manifest inspect $IMAGE > /dev/null 2>&1; then
              echo "‚úÖ $IMAGE is available"
              return 0
            else
              echo "‚ùå $IMAGE not found"
              return 1
            fi
          }

          # Check all images
          check_image "${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:$SHORT_SHA"
          check_image "${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:$SHORT_SHA"
          check_image "${{ secrets.DOCKERHUB_USERNAME }}/auth-service:$SHORT_SHA"
          check_image "${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:$SHORT_SHA"
          check_image "${{ secrets.DOCKERHUB_USERNAME }}/order-service:$SHORT_SHA"

          echo "‚úÖ All images verified on DockerHub"

      - name: Update Helm Values
        run: |
          echo "Updating Helm values.yaml with new image tags..."
          SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"
          DOCKERHUB_USER="${{ secrets.DOCKERHUB_USERNAME }}"

          # Update values.yaml with new image tags
          sed -i "s|repository: restaurant_management_frontend|repository: ${DOCKERHUB_USER}/restaurant-frontend|g" ${{ env.HELM_CHART_PATH }}/values.yaml
          sed -i "s|repository: restaurant_management_api-gateway|repository: ${DOCKERHUB_USER}/api-gateway|g" ${{ env.HELM_CHART_PATH }}/values.yaml
          sed -i "s|repository: restaurant_management_auth-service|repository: ${DOCKERHUB_USER}/auth-service|g" ${{ env.HELM_CHART_PATH }}/values.yaml
          sed -i "s|repository: restaurant_management_restaurant-service|repository: ${DOCKERHUB_USER}/restaurant-service|g" ${{ env.HELM_CHART_PATH }}/values.yaml
          sed -i "s|repository: restaurant_management_order-service|repository: ${DOCKERHUB_USER}/order-service|g" ${{ env.HELM_CHART_PATH }}/values.yaml

          # Update all image tags to the new commit SHA
          sed -i "s|tag: latest|tag: ${SHORT_SHA}|g" ${{ env.HELM_CHART_PATH }}/values.yaml
          sed -i "s|tag: analytics-v1|tag: ${SHORT_SHA}|g" ${{ env.HELM_CHART_PATH }}/values.yaml

          # Ensure imagePullPolicy is Always for production
          sed -i "s|pullPolicy: IfNotPresent|pullPolicy: Always|g" ${{ env.HELM_CHART_PATH }}/values.yaml
          sed -i "s|pullPolicy: Never|pullPolicy: Always|g" ${{ env.HELM_CHART_PATH }}/values.yaml

          echo "‚úÖ Helm values updated to use commit SHA: $SHORT_SHA"

      - name: Commit and Push Helm Values
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          git add ${{ env.HELM_CHART_PATH }}/values.yaml

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"
            git commit -m "Update Helm values to image tag $SHORT_SHA [skip ci]"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
            echo "‚úÖ Helm values updated and pushed"
          fi

      - name: Final Summary
        run: |
          echo "========================================="
          echo "‚úÖ Pipeline Complete"
          echo "========================================="
          SHORT_SHA="${{ needs.build-and-push.outputs.short_sha }}"
          echo "Image Tag: $SHORT_SHA"
          echo ""
          echo "üöÄ Helm values.yaml updated and committed"
          echo "üîÑ ArgoCD will now detect changes and upgrade the release"
          echo ""
          echo "Next steps:"
          echo "  1. ArgoCD syncs repository changes"
          echo "  2. ArgoCD runs: helm upgrade restaurant-system"
          echo "  3. Kubernetes pulls new images from DockerHub"
          echo "  4. Pods restart with new images"
          echo ""
          echo "üìä Monitor deployment:"
          echo "  kubectl get pods -n restaurant-system -w"
          echo "  helm status restaurant-system -n restaurant-system"
