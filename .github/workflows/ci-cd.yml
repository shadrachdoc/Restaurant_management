name: Build and Push Docker Images

on:
  push:
    branches:
      - main
      - developer
      - staging

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:latest,${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:${{ github.sha }}

      - name: Build and Push API Gateway
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/api-gateway/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:latest,${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:${{ github.sha }}

      - name: Build and Push Auth Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/auth-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest,${{ secrets.DOCKERHUB_USERNAME }}/auth-service:${{ github.sha }}

      - name: Build and Push Restaurant Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/restaurant-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:latest,${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:${{ github.sha }}

      - name: Build and Push Order Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/order-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/order-service:latest,${{ secrets.DOCKERHUB_USERNAME }}/order-service:${{ github.sha }}

      - name: Update Kubernetes Deployments
        run: |
          echo "Updating Kubernetes deployment files to use DockerHub images..."

          # Update frontend deployment
          sed -i "s|image: restaurant-frontend:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:latest|g" infrastructure/kubernetes/frontend-deployment.yaml
          sed -i "s|imagePullPolicy: IfNotPresent|imagePullPolicy: Always|g" infrastructure/kubernetes/frontend-deployment.yaml

          # Update api-gateway deployment
          sed -i "s|image: restaurant_management_api-gateway:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:latest|g" infrastructure/kubernetes/api-gateway-deployment.yaml
          sed -i "s|image: api-gateway:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:latest|g" infrastructure/kubernetes/api-gateway-deployment.yaml
          sed -i "s|imagePullPolicy: IfNotPresent|imagePullPolicy: Always|g" infrastructure/kubernetes/api-gateway-deployment.yaml

          # Update auth-service deployment
          sed -i "s|image: restaurant_management_auth-service:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest|g" infrastructure/kubernetes/auth-service-deployment.yaml
          sed -i "s|image: auth-service:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest|g" infrastructure/kubernetes/auth-service-deployment.yaml
          sed -i "s|imagePullPolicy: IfNotPresent|imagePullPolicy: Always|g" infrastructure/kubernetes/auth-service-deployment.yaml

          # Update restaurant-service deployment
          sed -i "s|image: restaurant_management_restaurant-service:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:latest|g" infrastructure/kubernetes/restaurant-service-deployment.yaml
          sed -i "s|image: restaurant-service:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:latest|g" infrastructure/kubernetes/restaurant-service-deployment.yaml
          sed -i "s|imagePullPolicy: IfNotPresent|imagePullPolicy: Always|g" infrastructure/kubernetes/restaurant-service-deployment.yaml

          # Update order-service deployment
          sed -i "s|image: order-service:latest|image: ${{ secrets.DOCKERHUB_USERNAME }}/order-service:latest|g" infrastructure/kubernetes/order-service-deployment.yaml
          sed -i "s|imagePullPolicy: IfNotPresent|imagePullPolicy: Always|g" infrastructure/kubernetes/order-service-deployment.yaml

          echo "‚úÖ Deployment files updated successfully!"

      - name: Commit and Push Deployment Updates
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

          git add infrastructure/kubernetes/*.yaml

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update deployments to use DockerHub images [skip ci]"
            git push
          fi

      - name: Summary
        run: |
          echo "========================================="
          echo "‚úÖ Build, Push & Deploy Update Complete"
          echo "========================================="
          echo "Images pushed to DockerHub:"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-frontend:latest"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/api-gateway:latest"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/auth-service:latest"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/restaurant-service:latest"
          echo "  ‚úì ${{ secrets.DOCKERHUB_USERNAME }}/order-service:latest"
          echo ""
          echo "üìù Images tagged with:"
          echo "  - latest"
          echo "  - ${{ github.sha }}"
          echo ""
          echo "üöÄ Deployment files updated and committed"
          echo "ArgoCD will automatically detect changes and deploy"
