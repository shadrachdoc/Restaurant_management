name: Build and Load Images to KIND

on:
  push:
    branches:
      - main
      - developer
      - staging

env:
  KIND_CLUSTER_NAME: restaurant-cluster

jobs:
  build-and-load:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build All Images
        run: |
          echo "Building Docker images..."
          docker build -f frontend/Dockerfile -t restaurant-frontend:latest .
          docker build -f services/api-gateway/Dockerfile -t api-gateway:latest .
          docker build -f services/auth-service/Dockerfile -t auth-service:latest .
          docker build -f services/restaurant-service/Dockerfile -t restaurant-service:latest .
          docker build -f services/order-service/Dockerfile -t order-service:latest .
          echo "✓ All images built successfully!"

      - name: Load Images into KIND Cluster
        run: |
          echo "Loading images into KIND cluster: ${KIND_CLUSTER_NAME}"
          docker save restaurant-frontend:latest | kind load image-archive /dev/stdin --name ${KIND_CLUSTER_NAME}
          docker save api-gateway:latest | kind load image-archive /dev/stdin --name ${KIND_CLUSTER_NAME}
          docker save auth-service:latest | kind load image-archive /dev/stdin --name ${KIND_CLUSTER_NAME}
          docker save restaurant-service:latest | kind load image-archive /dev/stdin --name ${KIND_CLUSTER_NAME}
          docker save order-service:latest | kind load image-archive /dev/stdin --name ${KIND_CLUSTER_NAME}
          echo "✓ All images loaded successfully!"

      - name: Summary
        run: |
          echo "========================================="
          echo "✅ Build & Load Complete"
          echo "========================================="
          echo "Cluster: ${KIND_CLUSTER_NAME}"
          echo "Images:"
          echo "  ✓ restaurant-frontend:latest"
          echo "  ✓ api-gateway:latest"
          echo "  ✓ auth-service:latest"
          echo "  ✓ restaurant-service:latest"
          echo "  ✓ order-service:latest"
          echo ""
          echo "ArgoCD will auto-deploy the changes."
