kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: restaurant-cluster
nodes:
  # Control plane node
  - role: control-plane
    kubeadmConfigPatches:
    - |
      kind: InitConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "ingress-ready=true"
    extraPortMappings:
    # API Gateway
    - containerPort: 30000
      hostPort: 8000
      protocol: TCP
    # Frontend
    - containerPort: 30001
      hostPort: 3000
      protocol: TCP
    # Auth Service (for debugging)
    - containerPort: 30002
      hostPort: 8001
      protocol: TCP
    # Restaurant Service
    - containerPort: 30003
      hostPort: 8003
      protocol: TCP
    # Order Service
    - containerPort: 30004
      hostPort: 8004
      protocol: TCP
    # Kitchen Service
    - containerPort: 30005
      hostPort: 8005
      protocol: TCP
    # RabbitMQ Management
    - containerPort: 30006
      hostPort: 15672
      protocol: TCP
    # Ingress HTTP
    - containerPort: 80
      hostPort: 80
      protocol: TCP
    # Ingress HTTPS
    - containerPort: 443
      hostPort: 443
      protocol: TCP

  # Worker nodes
  - role: worker
  - role: worker

# Networking
networking:
  # By default the API server listens on a random open port.
  # You may choose a specific port but probably don't need to in most cases.
  # Using a random port makes it easier to spin up multiple clusters.
  apiServerPort: 6443

  # By default kind uses the default CNI, to disable set this to none
  disableDefaultCNI: false

  # Configure pod subnet
  podSubnet: "10.244.0.0/16"

  # Configure service subnet
  serviceSubnet: "10.96.0.0/16"

# Feature gates
featureGates:
  EphemeralContainers: true
