apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: api-gateway
  namespace: restaurant-management
spec:
  host: api-gateway

  # Traffic policy
  trafficPolicy:
    # Load balancing
    loadBalancer:
      simple: LEAST_REQUEST

    # Connection pool settings
    connectionPool:
      tcp:
        maxConnections: 200
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 200
        maxRequestsPerConnection: 2
        idleTimeout: 300s

    # Outlier detection (circuit breaking)
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 50

  # Subsets for canary/blue-green deployments
  subsets:
    - name: stable
      labels:
        version: stable
      trafficPolicy:
        loadBalancer:
          simple: LEAST_REQUEST
